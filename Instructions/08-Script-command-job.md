---
lab:
  title: 在 Azure Machine Learning 中以命令作業身分執行定型指令碼
---

# 在 Azure Machine Learning 中以命令作業身分執行定型指令碼

筆記本非常適合用於實驗和開發。 一旦您開發機器學習模型並準備好用於生產環境之後，您會想要使用腳本進行定型。 您可以執行腳本作為命令作業。

在此練習中，您將測試腳本，然後以命令作業的形式執行。

## 開始之前

您將需要具有系統管理層級存取權的 [Azure 訂用帳戶](https://azure.microsoft.com/free?azure-portal=true)。

## 佈建 Azure Machine Learning 工作區

Azure Machine Learning *工作區* 提供集中位置來管理您需要定型和管理模型的所有資源和資產。 您可以透過 Studio、Python SDK 和 Azure CLI 與 Azure Machine Learning 工作區互動。

您將使用 Azure CLI 來布建工作區和必要的計算，並使用 Python SDK 來執行命令作業。

### 建立工作區和計算資源

若要建立 Azure Machine Learning 工作區、計算實例和計算叢集，您將使用 Azure CLI。 所有必要的命令都會分組在殼層腳本中，供您執行。

1. 在瀏覽器中，開啟位於 的 `https://portal.azure.com/` Azure 入口網站，使用您的 Microsoft 帳戶登入。
1. 選取搜尋 \[ 方塊右側頁面頂端的>_*] (Cloud Shell*) 按鈕。 這會在入口網站底部開啟 Cloud Shell 窗格。
1. 如果系統詢問，請選取 **[Bash** ]。 第一次開啟 Cloud Shell 時，系統會要求您選擇您想要使用 (*Bash* 或 *PowerShell*) 的殼層類型。
1. 如果系統要求您為 Cloud Shell 建立 **儲存體** ，請檢查是否已指定正確的訂用帳戶，然後選取 [建立儲存體]。 等候儲存體建立。
1. 在終端機中，輸入下列命令以複製此存放庫：

    ```azurecli
    rm -r azure-ml-labs -f
    git clone https://github.com/MicrosoftLearning/mslearn-azure-ml.git azure-ml-labs
    ```

    > 使用 `SHIFT + INSERT` 將複製的程式碼貼入Cloud Shell。

1. 複製存放庫之後，輸入下列命令來變更此實驗室的資料夾，並執行其包含 **的 setup.sh** 腳本：
    
    ```azurecli
    cd azure-ml-labs/Labs/08
    ./setup.sh
    ```

    > 忽略任何 (錯誤，) 表示未安裝延伸模組的訊息。

1. 等候腳本完成 - 這通常需要大約 5-10 分鐘的時間。

## 複製實驗室資料

當您建立工作區和必要的計算資源時，您可以開啟Azure Machine Learning 工作室，並將實驗室資料複製到工作區。

1. 在Azure 入口網站中，流覽至名為**mlw-dp100-... 的**Azure Machine Learning 工作區。
1. 選取 Azure Machine Learning 工作區，然後在其 [ **概觀** ] 頁面中，選取 **[啟動 Studio**]。 另一個索引標籤會在瀏覽器中開啟，以開啟Azure Machine Learning 工作室。
1. 關閉任何出現在 Studio 中的快顯視窗。
1. 在Azure Machine Learning 工作室中，流覽至 [**計算**] 頁面，並確認您在上一節中建立的計算實例和叢集是否存在。 計算實例應該正在執行，叢集應該閒置，且有 0 個節點正在執行。
1. 在 [ **計算實例] 索引標籤中** ，尋找您的計算實例，然後選取 **[終端機** ] 應用程式。
1. 在終端機中，在終端機中執行下列命令，在計算實例上安裝 Python SDK：

    ```
    pip uninstall azure-ai-ml
    pip install azure-ai-ml
    ```

    > 忽略任何 (錯誤) 訊息，指出找不到並卸載套件。

1. 執行下列命令，將包含筆記本、資料和其他檔案的 Git 存放庫複製到您的工作區：

    ```
    git clone https://github.com/MicrosoftLearning/mslearn-azure-ml.git azure-ml-labs
    ```

1. 當命令完成時，按一下 [ **檔案** ] 窗格中 ** 的 [&#8635;** ] 重新整理檢視，並確認已建立新的 **Users/*your-user-name/azure-ml-labs* ** 資料夾。

## 將筆記本轉換成指令碼

使用附加至計算實例的筆記本很適合用於實驗和開發，因為它可讓您立即執行您已撰寫的程式碼，並檢閱其輸出。 若要從開發移至生產環境，您會想要使用腳本。 在第一個步驟中，您可以使用 Azure Machine Learning 工作室 將筆記本轉換成腳本。

1. 開啟 **Labs/08/src/Train classification model.ipynb** Notebook。

    > 如果出現通知要求您進行驗證，請選取 [ **驗證** ]，並遵循必要的步驟。

1. 確認筆記本使用 **Python 3.8 - AzureML** 核心。
1. 執行所有儲存格來探索程式碼並定型模型。
1. 選取筆記本頂端的 &#9776; 圖示，以檢視 **筆記本功能表**。
1. 展開 **[匯出為**]，然後選取 [ **Python] (.py) ** 將筆記本轉換成 Python 腳本。
1. 將新檔案命名為 `train-classification-model`。
1. 建立新檔案之後，應該會自動開啟腳本。 探索檔案，並注意它包含與筆記本相同的程式碼。
1. 選取筆記本頂端的 &#9655;&#9655; 圖示，以 **儲存並執行終端機中的腳本**。
1. 腳本是由 **命令 python train-classification-model.py 起始，** 輸出應該會顯示在命令下方。

## 使用終端機測試腳本

將筆記本轉換成腳本之後，您可能會想要進一步精簡。 使用腳本時的其中一個最佳做法是使用函式。 當您的腳本包含函式時，比較容易對程式碼進行單元測試。 當您使用函式時，腳本會包含程式碼區塊，每個執行特定工作的區塊。

1. 開啟 **Labs/08/src/train-model-parameters.py** 腳本，並探索其內容。
    請注意，有一個主要函式包含四個其他函式：

    - 讀取資料
    - 分割資料
    - 定型模型
    - 評估模型

    在 main 函式之後，會定義每個函式。 請注意每個函式如何定義預期的輸入和輸出。

1. 選取筆記本頂端的 &#9655;&#9655; 圖示，以 **儲存並執行終端機中的腳本**。 您應該會在 **讀取資料** 之後收到錯誤...，告知因為檔案路徑無效而無法取得資料。

    腳本可讓您將程式碼參數化，以輕鬆地變更輸入資料或參數。 在此情況下，腳本會預期未提供之資料路徑的輸入參數。 您可以在 **parse_args () ** 函式的腳本結尾找到已定義和預期的參數。

    已定義兩個輸入參數：
    - **--training_data** 預期字串。
    - **--reg_rate** 預期數位，但預設值為 0.01。

    若要成功執行腳本，您必須指定定型資料參數的值。 讓我們藉由參考儲存在定型腳本相同資料夾中 ** 的diabetes.csv** 檔案來執行此動作。

1. 在終端機中執行下列命令：

    ```
    python train-model-parameters.py --training_data diabetes.csv
    ```

腳本應該會成功執行，因此輸出應該會顯示定型模型的精確度和 AUC。

在終端機中測試腳本很適合用來驗證腳本是否如預期般運作。 如果程式碼發生任何問題，您將會在終端機中收到錯誤。

**或者**，編輯程式碼以強制錯誤，並在終端機中再次執行命令以執行腳本。 例如，移除行 **匯入 pandas 做為 pd**，使用輸入參數儲存並執行腳本，以檢閱錯誤訊息。

## 將指令碼當作命令作業執行

如果您知道腳本可運作，您可以將它當做命令作業來執行。 藉由以命令作業的形式執行腳本，您將能夠追蹤腳本的所有輸入和輸出。

1. 開啟 **Labs/08/Run script as command job.ipynb** Notebook。
1. 在筆記本中執行所有儲存格。
1. 在Azure Machine Learning 工作室中，流覽至 [**作業]** 頁面。
1. 流覽至 **diabetes-train-script** 作業，以探索您所執行命令作業的概觀。
1. 流覽至 [ **程式碼]** 索引標籤。此處會複製 **src** 資料夾的所有內容，這是命令作業之 **程式碼** 參數的值。 您可以檢閱命令作業所執行的定型腳本。
1. 流覽至 [ **輸出 + 記錄]** 索引標籤。
1. 開啟 **std_log.txt** 檔案並探索其內容。 此檔案的內容是命令的輸出。 請記住，當您在該處測試腳本時，終端機中會顯示相同的輸出。 如果作業因為腳本發生問題而失敗，則會在這裡顯示錯誤訊息。

**或者**，編輯程式碼以強制發生錯誤，並使用筆記本再次起始命令作業。 例如，從腳本中移除 **行匯入 pandas 做為 pd** ，然後儲存腳本。 或者，編輯命令作業組態，以在作業組態本身發生錯誤時探索錯誤訊息，而不是腳本。

## 刪除 Azure 資源

當您完成探索 Azure Machine Learning 時，應該刪除您所建立的資源，以避免不必要的 Azure 成本。

1. 關閉 [Azure Machine Learning 工作室] 索引標籤，並返回Azure 入口網站。
1. 在 Azure 入口網站的 [首頁] 上，選取 [資源群組]。
1. 選取 **rg-dp100-...** 資源群組。
1. 在資源群組的 [概觀] 頁面頂端，選取 [刪除資源群組]。
1. 輸入資源群組名稱以確認要刪除，然後選取 [刪除]。
